# Load packages
library(sf)
library(spdep)
library(inlabru)
library(INLA)
library(ggplot2)
library(sp)
library(maptools)
library(dplyr)
library(patchwork)
library(viridisLite)
library(plyr)
library(parallel)

cluster = F

if(cluster == F){
  source(here::here("/Users/stephenjunvillejo/Documents/Phd Studies - University of Glasgow/PhD Dissert/Model runs/R/INLABRU/Simulations/RegressionCalibration/utils/stephen_utils.R"))
  source(here::here("/Users/stephenjunvillejo/Documents/Phd Studies - University of Glasgow/PhD Dissert/Model runs/R/INLABRU/Simulations/RegressionCalibration/utils/BasicFunctions.R"))
  save.path = "/Users/stephenjunvillejo/Documents/temp2/"
}else{
  source(here::here("/home/pgrad2/2510006v/INLABRU/utils/stephen_utils.R"))
  source(here::here("/home/pgrad2/2510006v/INLABRU/utils/BasicFunctions.R"))
}


sigma_omega = sqrt(10) # marginal standard deviation of the spatial field
sigma_error = 1 # marginal standard deviation of the error field

n_monitors_vec = c(10,25,40) # number of stations
true.vals <- list(stage_1 = list(rho = 2, # range parameter of the spatial field
                                 tau = 1/(sigma_omega^2), # precision parameter 
                                 sigma_omega = sigma_omega, # marginal standard deviation of the spatial field
                                 beta0 = 10, # intercept in the latent process x(s)
                                 beta1 = 3, # coefficient of covariate z(s)
                                 alpha1 = 1.1, # multiplicative bias
                                 sigma_e = .5, # measurement error standard deviation
                                 rho.error = 1, # range parameter of the error field
                                 tau.error = 1/(sigma_error^2), # precision parameter
                                 sigma_error = sigma_error)) # marginal standard deviation of the error field
ncores = detectCores()


One_sim_run_ortho_error <- function(sim_data = sim_data,
                                    max_iter = max_iter,
                                    tolerance = tolerance, 
                                    informative = informative){
  
  compile_I_x_monsonly <- vector("list", length = 3)
  compile_I_x_datafusion <- vector("list", length = 3)
  compile_I_x_regcalib <- vector("list", length = 3)
  
  compile_P_x_monsonly <- vector("list", length = 3)
  compile_P_x_datafusion <- vector("list", length = 3)
  compile_P_x_regcalib <- vector("list", length = 3)
  
  compile_Corr_x_monsonly <- vector("list", length = 3)
  compile_Corr_x_datafusion <- vector("list", length = 3)
  compile_Corr_x_regcalib <- vector("list", length = 3)
  
  compile_Time_monsonly <- vector("list", length = 3)
  compile_Time_datafusion <- vector("list", length = 3)
  compile_Time_regcalib <- vector("list", length = 3)
  
  compile_I_spde_monsonly <- vector("list", length = 3)
  compile_I_spde_datafusion <- vector("list", length = 3)
  compile_I_spde_regcalib <- vector("list", length = 3)
  
  compile_I_x_v2_monsonly <- vector("list", length = 3)
  compile_I_x_v2_datafusion <- vector("list", length = 3)
  compile_I_x_v2_regcalib <- vector("list", length = 3)
  
  compile_I_x_v2_field_monsonly <- vector("list", length = 3)
  compile_I_x_v2_field_datafusion <- vector("list", length = 3)
  compile_I_x_v2_field_regcalib <- vector("list", length = 3)
  
  compile_I_Ave_SD_monsonly <- vector("list", length = 3)
  compile_I_Ave_SD_datafusion <- vector("list", length = 3)
  compile_I_Ave_SD_regcalib <- vector("list", length = 3)
  
  compile_mlik_data1 <- vector("list", length = 6)
  compile_mlik_data2 <- vector("list", length = 6)
  compile_mlik_data3 <- vector("list", length = 6)
  
  compile_bmaweights_data1 <- vector("list", length = 6)
  compile_bmaweights_data2 <- vector("list", length = 6)
  compile_bmaweights_data3 <- vector("list", length = 6)
  
  index_model <- vector("list", length = 3)
  
  compile_paramestimates_monsonly <- vector("list", length = 3)
  compile_paramestimates_datafusion <- vector("list", length = 3)
  compile_paramestimates_regcalib <- vector("list", length = 3)
  
  sim_data_1 <- sim_data
  sim_data_2 <- sim_data
  sim_data_3 <- sim_data
  sim_data_1$monitors_data <- sim_data$monitors_data[[1]]
  sim_data_2$monitors_data <- sim_data$monitors_data[[2]]
  sim_data_3$monitors_data <- sim_data$monitors_data[[3]]
  
  alpha_grid = c(0.8,0.9,1,1.1,1.2,1.3)
  res_sim_data_1 <- lapply(1:6, function(i){
    Fit_Ortho_Error_v5(data = sim_data_1,
                       max_iter = max_iter,
                       tolerance = tolerance,
                       informative = informative,
                       a = alpha_grid[i])}
  )
  res_sim_data_2 <- lapply(1:6, function(i){
    Fit_Ortho_Error_v5(data = sim_data_2,
                       max_iter = max_iter,
                       tolerance = tolerance,
                       informative = informative,
                       a = alpha_grid[i])}
  )
  res_sim_data_3 <- lapply(1:6, function(i){
    Fit_Ortho_Error_v5(data = sim_data_3,
                       max_iter = max_iter,
                       tolerance = tolerance,
                       informative = informative,
                       a = alpha_grid[i])}
  )
  
  res_mons_only_1 <- Fit_Mons_only_v3(data = sim_data_1,
                                      max_iter = max_iter,
                                      tolerance = tolerance,
                                      informative = informative)
  res_mons_only_2 <- Fit_Mons_only_v3(data = sim_data_2,
                                      max_iter = max_iter,
                                      tolerance = tolerance,
                                      informative = informative)
  res_mons_only_3 <- Fit_Mons_only_v3(data = sim_data_3,
                                      max_iter = max_iter,
                                      tolerance = tolerance,
                                      informative = informative)
  
  
  res_regcalib_1 <- Fit_Regcalib_only_v2(data = sim_data_1,
                                         max_iter = max_iter,
                                         tolerance = tolerance,
                                         informative = informative)
  res_regcalib_2 <- Fit_Regcalib_only_v2(data = sim_data_2,
                                         max_iter = max_iter,
                                         tolerance = tolerance,
                                         informative = informative)
  res_regcalib_3 <- Fit_Regcalib_only_v2(data = sim_data_3,
                                         max_iter = max_iter,
                                         tolerance = tolerance,
                                         informative = informative)
  
  
  
  
  compile_mlik_data1[[1]] <- res_sim_data_1[[1]]$fit_res$mlik[1,1]
  compile_mlik_data1[[2]] <- res_sim_data_1[[2]]$fit_res$mlik[1,1]
  compile_mlik_data1[[3]] <- res_sim_data_1[[3]]$fit_res$mlik[1,1]
  compile_mlik_data1[[4]] <- res_sim_data_1[[4]]$fit_res$mlik[1,1]
  compile_mlik_data1[[5]] <- res_sim_data_1[[5]]$fit_res$mlik[1,1]
  compile_mlik_data1[[6]] <- res_sim_data_1[[6]]$fit_res$mlik[1,1]
  
  mliks_method_data1 <- unlist(compile_mlik_data1)
  bma.w.method_data1 <- exp(mliks_method_data1 - max(mliks_method_data1))
  bma.w.method_data1 <- bma.w.method_data1/sum(bma.w.method_data1)
  
  compile_mlik_data2[[1]] <- res_sim_data_2[[1]]$fit_res$mlik[1,1]
  compile_mlik_data2[[2]] <- res_sim_data_2[[2]]$fit_res$mlik[1,1]
  compile_mlik_data2[[3]] <- res_sim_data_2[[3]]$fit_res$mlik[1,1]
  compile_mlik_data2[[4]] <- res_sim_data_2[[4]]$fit_res$mlik[1,1]
  compile_mlik_data2[[5]] <- res_sim_data_2[[5]]$fit_res$mlik[1,1]
  compile_mlik_data2[[6]] <- res_sim_data_2[[6]]$fit_res$mlik[1,1]
  
  mliks_method_data2 <- unlist(compile_mlik_data2)
  bma.w.method_data2 <- exp(mliks_method_data2 - max(mliks_method_data2))
  bma.w.method_data2 <- bma.w.method_data2/sum(bma.w.method_data2)
  
  compile_mlik_data3[[1]] <- res_sim_data_3[[1]]$fit_res$mlik[1,1]
  compile_mlik_data3[[2]] <- res_sim_data_3[[2]]$fit_res$mlik[1,1]
  compile_mlik_data3[[3]] <- res_sim_data_3[[3]]$fit_res$mlik[1,1]
  compile_mlik_data3[[4]] <- res_sim_data_3[[4]]$fit_res$mlik[1,1]
  compile_mlik_data3[[5]] <- res_sim_data_3[[5]]$fit_res$mlik[1,1]
  compile_mlik_data3[[6]] <- res_sim_data_3[[6]]$fit_res$mlik[1,1]
  
  mliks_method_data3 <- unlist(compile_mlik_data3)
  bma.w.method_data3 <- exp(mliks_method_data3 - max(mliks_method_data3))
  bma.w.method_data3 <- bma.w.method_data3/sum(bma.w.method_data3)
  
  
  index_model[[1]] <- which(compile_mlik_data1 == max(unlist(compile_mlik_data1)))
  index_model[[2]] <- which(compile_mlik_data2 == max(unlist(compile_mlik_data2)))
  index_model[[3]] <- which(compile_mlik_data3 == max(unlist(compile_mlik_data3)))
  
  # compile_bmaweights_data1[[1]] <- bma.w.method_data1
  # compile_bmaweights_data2[[1]] <- bma.w.method_data2
  # compile_bmaweights_data3[[1]] <- bma.w.method_data3
  
  I_x_monsonly_1 = compute_I_x_v3(model = res_mons_only_1$fit_res,
                                  data = sim_data_1$px,
                                  stations = sim_data_1$monitors_data)
  I_x_monsonly_2 = compute_I_x_v3(model = res_mons_only_2$fit_res,
                                  data = sim_data_2$px,
                                  stations = sim_data_2$monitors_data)
  I_x_monsonly_3 = compute_I_x_v3(model = res_mons_only_3$fit_res,
                                  data = sim_data_3$px,
                                  stations = sim_data_3$monitors_data)
                               
  I_x_regcalib_1 = compute_I_x_regcalib(model = res_regcalib_1,
                                        data = sim_data_1$px,
                                        stations = sim_data_1$monitors_data)
  I_x_regcalib_2 = compute_I_x_regcalib(model = res_regcalib_2,
                                        data = sim_data_2$px,
                                        stations = sim_data_2$monitors_data)
  I_x_regcalib_3 = compute_I_x_regcalib(model = res_regcalib_3,
                                        data = sim_data_3$px,
                                        stations = sim_data_3$monitors_data)
                               
                         
  

  
  I_x_datafus_1 = compute_I_x_datafus(model_list = res_sim_data_1,
                                      weights = bma.w.method_data1,
                                      data = sim_data_1$px,
                                      stations = sim_data_1$monitors_data,
                                      ind_model = index_model[[1]])
  I_x_datafus_2 = compute_I_x_datafus(model_list = res_sim_data_2,
                                      weights = bma.w.method_data2,
                                      data = sim_data_2$px,
                                      stations = sim_data_2$monitors_data,
                                      ind_model = index_model[[2]])
  I_x_datafus_3 = compute_I_x_datafus(model_list = res_sim_data_3,
                                      weights = bma.w.method_data3,
                                      data = sim_data_3$px,
                                      stations = sim_data_3$monitors_data,
                                      ind_model = index_model[[3]])
  
  
  compile_I_x_monsonly[[1]] <- I_x_monsonly_1$I_x
  compile_I_x_monsonly[[2]] <- I_x_monsonly_2$I_x
  compile_I_x_monsonly[[3]] <- I_x_monsonly_3$I_x
  
  compile_I_x_regcalib[[1]] <- I_x_regcalib_1$I_x
  compile_I_x_regcalib[[2]] <- I_x_regcalib_2$I_x
  compile_I_x_regcalib[[3]] <- I_x_regcalib_3$I_x
  
  compile_I_x_datafusion[[1]] <- I_x_datafus_1$I_x
  compile_I_x_datafusion[[2]] <- I_x_datafus_2$I_x
  compile_I_x_datafusion[[3]] <- I_x_datafus_3$I_x
  
  compile_I_x_v2_monsonly[[1]] <- I_x_monsonly_1$I_x_v2
  compile_I_x_v2_monsonly[[2]] <- I_x_monsonly_2$I_x_v2
  compile_I_x_v2_monsonly[[3]] <- I_x_monsonly_3$I_x_v2

  compile_I_x_v2_regcalib[[1]] <- I_x_regcalib_1$I_x_v2
  compile_I_x_v2_regcalib[[2]] <- I_x_regcalib_2$I_x_v2
  compile_I_x_v2_regcalib[[3]] <- I_x_regcalib_3$I_x_v2
  
  compile_I_x_v2_datafusion[[1]] <- I_x_datafus_1$I_x_v2
  compile_I_x_v2_datafusion[[2]] <- I_x_datafus_2$I_x_v2
  compile_I_x_v2_datafusion[[3]] <- I_x_datafus_3$I_x_v2
  
  
  compile_I_x_v2_field_monsonly[[1]] <- I_x_monsonly_1$I_x_v2_field
  compile_I_x_v2_field_monsonly[[2]] <- I_x_monsonly_2$I_x_v2_field
  compile_I_x_v2_field_monsonly[[3]] <- I_x_monsonly_3$I_x_v2_field
  
  compile_I_x_v2_field_datafusion[[1]] <- I_x_datafus_1$I_x_v2_field
  compile_I_x_v2_field_datafusion[[2]] <- I_x_datafus_2$I_x_v2_field
  compile_I_x_v2_field_datafusion[[3]] <- I_x_datafus_3$I_x_v2_field
  
  compile_I_x_v2_field_regcalib[[1]] <- I_x_regcalib_1$I_x_v2_field
  compile_I_x_v2_field_regcalib[[2]] <- I_x_regcalib_2$I_x_v2_field
  compile_I_x_v2_field_regcalib[[3]] <- I_x_regcalib_3$I_x_v2_field
  
  compile_I_Ave_SD_monsonly[[1]] <- I_x_monsonly_1$ave_sd
  compile_I_Ave_SD_monsonly[[2]] <- I_x_monsonly_2$ave_sd
  compile_I_Ave_SD_monsonly[[3]] <- I_x_monsonly_3$ave_sd
  
  compile_I_Ave_SD_regcalib[[1]] <- I_x_regcalib_1$ave_sd
  compile_I_Ave_SD_regcalib[[2]] <- I_x_regcalib_2$ave_sd
  compile_I_Ave_SD_regcalib[[3]] <- I_x_regcalib_3$ave_sd
  
  compile_I_Ave_SD_datafusion[[1]] <- I_x_datafus_1$ave_sd
  compile_I_Ave_SD_datafusion[[2]] <- I_x_datafus_2$ave_sd
  compile_I_Ave_SD_datafusion[[3]] <- I_x_datafus_3$ave_sd
  
  
  compile_P_x_monsonly[[1]] <- I_x_monsonly_1$P_x
  compile_P_x_monsonly[[2]] <- I_x_monsonly_2$P_x
  compile_P_x_monsonly[[3]] <- I_x_monsonly_3$P_x
  
  compile_P_x_regcalib[[1]] <- I_x_regcalib_1$P_x
  compile_P_x_regcalib[[2]] <- I_x_regcalib_2$P_x
  compile_P_x_regcalib[[3]] <- I_x_regcalib_3$P_x
  
  compile_P_x_datafusion[[1]] <- I_x_datafus_1$P_x
  compile_P_x_datafusion[[2]] <- I_x_datafus_2$P_x
  compile_P_x_datafusion[[3]] <- I_x_datafus_3$P_x
  

  compile_Corr_x_monsonly[[1]] <- I_x_monsonly_1$Cor
  compile_Corr_x_monsonly[[2]] <- I_x_monsonly_2$Cor
  compile_Corr_x_monsonly[[3]] <- I_x_monsonly_3$Cor
  
  compile_Corr_x_regcalib[[1]] <- I_x_regcalib_1$Cor
  compile_Corr_x_regcalib[[2]] <- I_x_regcalib_2$Cor
  compile_Corr_x_regcalib[[3]] <- I_x_regcalib_3$Cor
  
  compile_Corr_x_datafusion[[1]] <- I_x_datafus_1$Cor
  compile_Corr_x_datafusion[[2]] <- I_x_datafus_2$Cor
  compile_Corr_x_datafusion[[3]] <- I_x_datafus_3$Cor
  
  compile_Time_datafusion[[1]] <- res_sim_data_1[[index_model[[1]]]]$time
  compile_Time_datafusion[[2]] <- res_sim_data_2[[index_model[[2]]]]$time
  compile_Time_datafusion[[3]] <- res_sim_data_3[[index_model[[3]]]]$time
  
  compile_Time_monsonly[[1]] <- res_mons_only_1$time
  compile_Time_monsonly[[2]] <- res_mons_only_2$time
  compile_Time_monsonly[[3]] <- res_mons_only_3$time
  
  compile_Time_regcalib[[1]] <- res_regcalib_1$time
  compile_Time_regcalib[[2]] <- res_regcalib_2$time
  compile_Time_regcalib[[3]] <- res_regcalib_3$time
  
  for(i in 1:3){
    res_temp <- get(paste0("res_mons_only_",i))
    compile_paramestimates_monsonly[[i]] <- list(inla.rmarginal(200, res_temp$fit_res$marginals.fixed$beta_0),
                                                 inla.rmarginal(200, res_temp$fit_res$marginals.fixed$beta_1),
                                                 inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Range for spde`),
                                                 inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Stdev for spde`),
                                                 inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Precision for the Gaussian observations`))
  }
  
  for(i in 1:3){
    res_temp <- get(paste0("res_sim_data_",i))
    res_temp <- res_temp[[index_model[[i]]]]
    compile_paramestimates_datafusion[[i]] <- list(inla.rmarginal(200, res_temp$fit_res$marginals.fixed$beta_0),
                                                   inla.rmarginal(200, res_temp$fit_res$marginals.fixed$beta_1),
                                                   inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Range for spde`),
                                                   inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Stdev for spde`),
                                                   inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Precision for the Gaussian observations`),
                                                   inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Range for matern_error`),
                                                   inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Stdev for matern_error`),
                                                   inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Precision for the Gaussian observations[2]`))
  }
  
  
  compile_paramestimates_datafusion_temp <- vector(mode = "list", length = 3)
  
  for(i in 1:3){
    res_temp <- get(paste0("res_sim_data_",i))
    for(j in 1:6){
      res_temp2 <- res_temp[[j]]
      compile_paramestimates_datafusion_temp[[i]][[j]] <- list(inla.rmarginal(200, res_temp2$fit_res$marginals.fixed$beta_0),
                                                               inla.rmarginal(200, res_temp2$fit_res$marginals.fixed$beta_1),
                                                               inla.rmarginal(200, res_temp2$fit_res$marginals.hyperpar$`Range for spde`),
                                                               inla.rmarginal(200, res_temp2$fit_res$marginals.hyperpar$`Stdev for spde`),
                                                               inla.rmarginal(200, res_temp2$fit_res$marginals.hyperpar$`Precision for the Gaussian observations`),
                                                               inla.rmarginal(200, res_temp2$fit_res$marginals.hyperpar$`Range for matern_error`),
                                                               inla.rmarginal(200, res_temp2$fit_res$marginals.hyperpar$`Stdev for matern_error`),
                                                               inla.rmarginal(200, res_temp2$fit_res$marginals.hyperpar$`Precision for the Gaussian observations[2]`))
    }
  }
  
  for(i in 1:3){
    temp <- compile_paramestimates_datafusion_temp[[i]]
    weights <- get(paste0("bma.w.method_data",i))
    for(j in 1:7){
      compile_paramestimates_datafusion[[i]][[j]] <- temp[[1]][[j]]*weights[1] + temp[[2]][[j]]*weights[2] + temp[[3]][[j]]*weights[3] + 
        temp[[4]][[j]]*weights[4] + temp[[5]][[j]]*weights[5] + temp[[6]][[j]]*weights[6]
      
    }
  }
  
  for(i in 1:3){
    res_temp <- get(paste0("res_regcalib_",i))
    compile_paramestimates_regcalib[[i]] <- list(inla.rmarginal(200, res_temp$fit_res$marginals.fixed$beta_0),
                                                 inla.rmarginal(200, res_temp$fit_res$marginals.fixed$beta_1),
                                                 inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Range for spde`),
                                                 inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Stdev for spde`),
                                                 inla.rmarginal(200, res_temp$fit_res$marginals.hyperpar$`Precision for the Gaussian observations`),
                                                 inla.rmarginal(200, res_temp$fit_res$marginals.fixed$beta_2))
                                        
  }
  
  return(out = list(compile_I_x_monsonly = compile_I_x_monsonly,
                    compile_I_x_regcalib = compile_I_x_regcalib,
                    compile_I_x_datafusion = compile_I_x_datafusion,
                    compile_P_x_monsonly = compile_P_x_monsonly,
                    compile_P_x_regcalib = compile_P_x_regcalib,
                    compile_P_x_datafusion = compile_P_x_datafusion,
                    compile_Corr_x_monsonly = compile_Corr_x_monsonly,
                    compile_Corr_x_regcalib = compile_Corr_x_regcalib,
                    compile_Corr_x_datafusion = compile_Corr_x_datafusion,
                    compile_Time_datafusion = compile_Time_datafusion,
                    compile_Time_regcalib = compile_Time_regcalib,
                    compile_Time_monsonly = compile_Time_monsonly,
                    compile_paramestimates_monsonly = compile_paramestimates_monsonly,
                    compile_paramestimates_regcalib = compile_paramestimates_regcalib,
                    compile_paramestimates_datafusion = compile_paramestimates_datafusion,
                    compile_mlik_data1 = compile_mlik_data1,
                    compile_mlik_data2 = compile_mlik_data2,
                    compile_mlik_data3 = compile_mlik_data3,
                    index_model = index_model,
                    compile_I_x_v2_field_monsonly = compile_I_x_v2_field_monsonly,
                    compile_I_x_v2_field_regcalib = compile_I_x_v2_field_regcalib,
                    compile_I_x_v2_field_datafusion = compile_I_x_v2_field_datafusion, 
                    compile_I_x_v2_monsonly = compile_I_x_v2_monsonly,
                    compile_I_x_v2_regcalib = compile_I_x_v2_regcalib,
                    compile_I_x_v2_datafusion = compile_I_x_v2_datafusion,
                    compile_I_Ave_SD_monsonly = compile_I_Ave_SD_monsonly,
                    compile_I_Ave_SD_regcalib = compile_I_Ave_SD_regcalib,
                    compile_I_Ave_SD_datafusion = compile_I_Ave_SD_datafusion,
                    compile_bmaweights_data1 = bma.w.method_data1,
                    compile_bmaweights_data2 = bma.w.method_data2,
                    compile_bmaweights_data3 = bma.w.method_data3))
  
}

Full_sim_ortho_error <- function(n_sim = n_sim,
                                 max_iter = max_iter,
                                 tolerance = tolerance){
  
  compile_I_x_monsonly_info <- vector("list", length = 3)
  compile_I_x_regcalib_info <- vector("list", length = 3)
  compile_I_x_datafusion_info <- vector("list", length = 3)
  compile_I_x_v2_field_monsonly_info <- vector("list", length = 3)
  compile_I_x_v2_field_regcalib_info <- vector("list", length = 3)
  compile_I_x_v2_field_datafusion_info <- vector("list", length = 3)
  compile_I_x_v2_monsonly_info <- vector("list", length = 3)
  compile_I_x_v2_regcalib_info <- vector("list", length = 3)
  compile_I_x_v2_datafusion_info <- vector("list", length = 3)
  compile_Ave_SD_monsonly_info <- vector("list", length = 3)
  compile_Ave_SD_regcalib_info <- vector("list", length = 3)
  compile_Ave_SD_datafus_info <- vector("list", length = 3)
  compile_P_x_monsonly_info <- vector("list", length = 3)
  compile_P_x_regcalib_info <- vector("list", length = 3)
  compile_P_x_datafusion_info <- vector("list", length = 3)
  compile_Corr_x_monsonly_info <- vector("list", length = 3)
  compile_Corr_x_regcalib_info <- vector("list", length = 3)
  compile_Corr_x_datafusion_info <- vector("list", length = 3)
  compile_Time_monsonly_info <- vector("list", length = 3)
  compile_Time_regcalib_info <- vector("list", length = 3)
  compile_Time_datafusion_info <- vector("list", length = 3)
  compile_paramestimates_datafusion_info <- vector("list", length = 3)
  compile_paramestimates_regcalib_info <- vector("list", length = 3)
  compile_paramestimates_monsonly_info <- vector("list", length = 3)
  
  for(i in 1:3){
    compile_paramestimates_datafusion_info[[i]] <- vector("list", length = 8)
    compile_paramestimates_regcalib_info[[i]] <- vector("list", length = 6)
    compile_paramestimates_monsonly_info[[i]] <- vector("list", length = 5)
  }
  
  compile_I_x_monsonly_noninfo <- vector("list", length = 3)
  compile_I_x_regcalib_noninfo <- vector("list", length = 3)
  compile_I_x_datafusion_noninfo <- vector("list", length = 3)
  compile_I_x_v2_field_monsonly_noninfo <- vector("list", length = 3)
  compile_I_x_v2_field_regcalib_noninfo <- vector("list", length = 3)
  compile_I_x_v2_field_datafusion_noninfo <- vector("list", length = 3)
  compile_I_x_v2_monsonly_noninfo <- vector("list", length = 3)
  compile_I_x_v2_regcalib_noninfo <- vector("list", length = 3)
  compile_I_x_v2_datafusion_noninfo <- vector("list", length = 3)
  compile_Ave_SD_monsonly_noninfo <- vector("list", length = 3)
  compile_Ave_SD_regcalib_noninfo <- vector("list", length = 3)
  compile_Ave_SD_datafus_noninfo <- vector("list", length = 3)
  compile_P_x_monsonly_noninfo <- vector("list", length = 3)
  compile_P_x_regcalib_noninfo <- vector("list", length = 3)
  compile_P_x_datafusion_noninfo <- vector("list", length = 3)
  compile_Corr_x_monsonly_noninfo <- vector("list", length = 3)
  compile_Corr_x_regcalib_noninfo <- vector("list", length = 3)
  compile_Corr_x_datafusion_noninfo <- vector("list", length = 3)
  compile_Time_monsonly_noninfo <- vector("list", length = 3)
  compile_Time_regcalib_noninfo <- vector("list", length = 3)
  compile_Time_datafusion_noninfo <- vector("list", length = 3)
  compile_paramestimates_datafusion_noninfo <- vector("list", length = 3)
  compile_paramestimates_regcalib_noninfo <- vector("list", length = 3)
  compile_paramestimates_monsonly_noninfo <- vector("list", length = 3)
  
  for(i in 1:3){
    compile_paramestimates_datafusion_noninfo[[i]] <- vector("list", length = 8)
    compile_paramestimates_regcalib_noninfo[[i]] <- vector("list", length = 6)
    compile_paramestimates_monsonly_noninfo[[i]] <- vector("list", length = 5)
  }
  
  compile_mlik_data1_info <- vector("list", length = 6)
  compile_mlik_data2_info <- vector("list", length = 6)
  compile_mlik_data3_info <- vector("list", length = 6)
  compile_mlik_data1_noninfo <- vector("list", length = 6)
  compile_mlik_data2_noninfo <- vector("list", length = 6)
  compile_mlik_data3_noninfo <- vector("list", length = 6)
  
  compile_index_model_info <- vector("list", length = 3)
  compile_index_model_noninfo <- vector("list", length = 3)
  
  compile_weights_data1_info <- vector("list", length = 6)
  compile_weights_data2_info <- vector("list", length = 6)
  compile_weights_data3_info <- vector("list", length = 6)
  compile_weights_data1_noninfo <- vector("list", length = 6)
  compile_weights_data2_noninfo <- vector("list", length = 6)
  compile_weights_data3_noninfo <- vector("list", length = 6)
  
  for(n in 1:n_sim){
    
    sim_data <- Sim_Data_Ortho_error_v3()
    one_sim_informative <- One_sim_run_ortho_error(sim_data = sim_data,
                                                   max_iter = max_iter,
                                                   tolerance = tolerance,
                                                   informative = TRUE)
    one_sim_noninformative <- One_sim_run_ortho_error(sim_data = sim_data,
                                                      max_iter = max_iter,
                                                      tolerance = tolerance,
                                                      informative = FALSE)
    
    cat("Sim = ", n," out of ",n_sim, sep="","\n" )
    
    
    #### start here for wednesday
    
    for(i in 1:3){
      
      #info
      
      compile_I_x_monsonly_info[[i]] <- c(compile_I_x_monsonly_info[[i]], one_sim_informative$compile_I_x_monsonly[[i]])
      compile_I_x_regcalib_info[[i]] <- c(compile_I_x_regcalib_info[[i]], one_sim_informative$compile_I_x_regcalib[[i]])
      compile_I_x_datafusion_info[[i]] <- c(compile_I_x_datafusion_info[[i]], one_sim_informative$compile_I_x_datafusion[[i]])
      
      compile_I_x_v2_field_monsonly_info[[i]] <- c(compile_I_x_v2_field_monsonly_info[[i]], one_sim_informative$compile_I_x_v2_field_monsonly[[i]])
      compile_I_x_v2_field_regcalib_info[[i]] <- c(compile_I_x_v2_field_regcalib_info[[i]], one_sim_informative$compile_I_x_v2_field_regcalib[[i]])
      compile_I_x_v2_field_datafusion_info[[i]] <- c(compile_I_x_v2_field_datafusion_info[[i]], one_sim_informative$compile_I_x_v2_field_datafusion[[i]])
      
      compile_I_x_v2_monsonly_info[[i]] <- c(compile_I_x_v2_monsonly_info[[i]], one_sim_informative$compile_I_x_v2_monsonly[[i]])
      compile_I_x_v2_regcalib_info[[i]] <- c(compile_I_x_v2_regcalib_info[[i]], one_sim_informative$compile_I_x_v2_regcalib[[i]])
      compile_I_x_v2_datafusion_info[[i]] <- c(compile_I_x_v2_datafusion_info[[i]], one_sim_informative$compile_I_x_v2_datafusion[[i]])
      
      compile_Ave_SD_monsonly_info[[i]] <- c(compile_Ave_SD_monsonly_info[[i]], one_sim_informative$compile_I_Ave_SD_monsonly[[i]])
      compile_Ave_SD_regcalib_info[[i]] <- c(compile_Ave_SD_regcalib_info[[i]], one_sim_informative$compile_I_Ave_SD_regcalib[[i]])
      compile_Ave_SD_datafus_info[[i]] <- c(compile_Ave_SD_datafus_info[[i]], one_sim_informative$compile_I_Ave_SD_datafusion[[i]])
      
      compile_P_x_monsonly_info[[i]] <- c(compile_P_x_monsonly_info[[i]], one_sim_informative$compile_P_x_monsonly[[i]])
      compile_P_x_regcalib_info[[i]] <- c(compile_P_x_regcalib_info[[i]], one_sim_informative$compile_P_x_regcalib[[i]])
      compile_P_x_datafusion_info[[i]] <- c(compile_P_x_datafusion_info[[i]], one_sim_informative$compile_P_x_datafusion[[i]])
      
      compile_Corr_x_monsonly_info[[i]] <- c(compile_Corr_x_monsonly_info[[i]], one_sim_informative$compile_Corr_x_monsonly[[i]])
      compile_Corr_x_regcalib_info[[i]] <- c(compile_Corr_x_regcalib_info[[i]], one_sim_informative$compile_Corr_x_regcalib[[i]])
      compile_Corr_x_datafusion_info[[i]] <- c(compile_Corr_x_datafusion_info[[i]], one_sim_informative$compile_Corr_x_datafusion[[i]])
      
      compile_Time_monsonly_info[[i]] <- c(compile_Time_monsonly_info[[i]], one_sim_informative$compile_Time_monsonly[[i]])
      compile_Time_regcalib_info[[i]] <- c(compile_Time_regcalib_info[[i]], one_sim_informative$compile_Time_regcalib[[i]])
      compile_Time_datafusion_info[[i]] <- c(compile_Time_datafusion_info[[i]], one_sim_informative$compile_Time_datafusion[[i]])
      
      #noninfo
      
      compile_I_x_monsonly_noninfo[[i]] <- c(compile_I_x_monsonly_noninfo[[i]], one_sim_noninformative$compile_I_x_monsonly[[i]])
      compile_I_x_regcalib_noninfo[[i]] <- c(compile_I_x_regcalib_noninfo[[i]], one_sim_noninformative$compile_I_x_regcalib[[i]])
      compile_I_x_datafusion_noninfo[[i]] <- c(compile_I_x_datafusion_noninfo[[i]], one_sim_noninformative$compile_I_x_datafusion[[i]])
      
      compile_I_x_v2_field_monsonly_noninfo[[i]] <- c(compile_I_x_v2_field_monsonly_noninfo[[i]], one_sim_noninformative$compile_I_x_v2_field_monsonly[[i]])
      compile_I_x_v2_field_regcalib_noninfo[[i]] <- c(compile_I_x_v2_field_regcalib_noninfo[[i]], one_sim_noninformative$compile_I_x_v2_field_regcalib[[i]])
      compile_I_x_v2_field_datafusion_noninfo[[i]] <- c(compile_I_x_v2_field_datafusion_noninfo[[i]], one_sim_noninformative$compile_I_x_v2_field_datafusion[[i]])
      
      compile_I_x_v2_monsonly_noninfo[[i]] <- c(compile_I_x_v2_monsonly_noninfo[[i]], one_sim_noninformative$compile_I_x_v2_monsonly[[i]])
      compile_I_x_v2_regcalib_noninfo[[i]] <- c(compile_I_x_v2_regcalib_noninfo[[i]], one_sim_noninformative$compile_I_x_v2_regcalib[[i]])
      compile_I_x_v2_datafusion_noninfo[[i]] <- c(compile_I_x_v2_datafusion_noninfo[[i]], one_sim_noninformative$compile_I_x_v2_datafusion[[i]])
      
      compile_Ave_SD_monsonly_noninfo[[i]] <- c(compile_Ave_SD_monsonly_noninfo[[i]], one_sim_noninformative$compile_I_Ave_SD_monsonly[[i]])
      compile_Ave_SD_regcalib_noninfo[[i]] <- c(compile_Ave_SD_regcalib_noninfo[[i]], one_sim_noninformative$compile_I_Ave_SD_regcalib[[i]])
      compile_Ave_SD_datafus_noninfo[[i]] <- c(compile_Ave_SD_datafus_noninfo[[i]], one_sim_noninformative$compile_I_Ave_SD_datafusion[[i]])
      
      compile_P_x_monsonly_noninfo[[i]] <- c(compile_P_x_monsonly_noninfo[[i]], one_sim_noninformative$compile_P_x_monsonly[[i]])
      compile_P_x_regcalib_noninfo[[i]] <- c(compile_P_x_regcalib_noninfo[[i]], one_sim_noninformative$compile_P_x_regcalib[[i]])
      compile_P_x_datafusion_noninfo[[i]] <- c(compile_P_x_datafusion_noninfo[[i]], one_sim_noninformative$compile_P_x_datafusion[[i]])
      
      compile_Corr_x_monsonly_noninfo[[i]] <- c(compile_Corr_x_monsonly_noninfo[[i]], one_sim_noninformative$compile_Corr_x_monsonly[[i]])
      compile_Corr_x_regcalib_noninfo[[i]] <- c(compile_Corr_x_regcalib_noninfo[[i]], one_sim_noninformative$compile_Corr_x_regcalib[[i]])
      compile_Corr_x_datafusion_noninfo[[i]] <- c(compile_Corr_x_datafusion_noninfo[[i]], one_sim_noninformative$compile_Corr_x_datafusion[[i]])
      
      compile_Time_monsonly_noninfo[[i]] <- c(compile_Time_monsonly_noninfo[[i]], one_sim_noninformative$compile_Time_monsonly[[i]])
      compile_Time_regcalib_noninfo[[i]] <- c(compile_Time_regcalib_noninfo[[i]], one_sim_noninformative$compile_Time_regcalib[[i]])
      compile_Time_datafusion_noninfo[[i]] <- c(compile_Time_datafusion_noninfo[[i]], one_sim_noninformative$compile_Time_datafusion[[i]])
      
      compile_index_model_info[[i]] <- c(compile_index_model_info[[i]], one_sim_informative$index_model[[i]])
      compile_index_model_info[[i]] <- c(compile_index_model_info[[i]], one_sim_informative$index_model[[i]])
      compile_index_model_noninfo[[i]] <- c(compile_index_model_noninfo[[i]], one_sim_noninformative$index_model[[i]])
      
    }  
    
    for(i in 1:6){
      compile_mlik_data1_info[[i]] <- c(compile_mlik_data1_info[[i]], one_sim_informative$compile_mlik_data1[[i]])
      compile_mlik_data2_info[[i]] <- c(compile_mlik_data2_info[[i]], one_sim_informative$compile_mlik_data2[[i]])
      compile_mlik_data3_info[[i]] <- c(compile_mlik_data3_info[[i]], one_sim_informative$compile_mlik_data3[[i]])
      
      compile_mlik_data1_noninfo[[i]] <- c(compile_mlik_data1_noninfo[[i]], one_sim_noninformative$compile_mlik_data1[[i]])
      compile_mlik_data2_noninfo[[i]] <- c(compile_mlik_data2_noninfo[[i]], one_sim_noninformative$compile_mlik_data2[[i]])
      compile_mlik_data3_noninfo[[i]] <- c(compile_mlik_data3_noninfo[[i]], one_sim_noninformative$compile_mlik_data3[[i]])
      
      compile_weights_data1_info[[i]] <- c(compile_weights_data1_info[[i]], one_sim_informative$compile_bmaweights_data1[[i]])
      compile_weights_data2_info[[i]] <- c(compile_weights_data2_info[[i]], one_sim_informative$compile_bmaweights_data2[[i]])
      compile_weights_data3_info[[i]] <- c(compile_weights_data3_info[[i]], one_sim_informative$compile_bmaweights_data3[[i]])
      
      compile_weights_data1_noninfo[[i]] <- c(compile_weights_data1_noninfo[[i]], one_sim_noninformative$compile_bmaweights_data1[[i]])
      compile_weights_data2_noninfo[[i]] <- c(compile_weights_data2_noninfo[[i]], one_sim_noninformative$compile_bmaweights_data2[[i]])
      compile_weights_data3_noninfo[[i]] <- c(compile_weights_data3_noninfo[[i]], one_sim_noninformative$compile_bmaweights_data3[[i]])
      
      
    }
    
    for(i in 1:3){
      for(j in 1:8){
        compile_paramestimates_datafusion_info[[i]][[j]] <- c(compile_paramestimates_datafusion_info[[i]][[j]],
                                                              one_sim_informative$compile_paramestimates_datafusion[[i]][[j]])
        compile_paramestimates_datafusion_noninfo[[i]][[j]] <- c(compile_paramestimates_datafusion_noninfo[[i]][[j]],
                                                                 one_sim_noninformative$compile_paramestimates_datafusion[[i]][[j]])
      }
      for(j in 1:5){
        compile_paramestimates_monsonly_info[[i]][[j]] <- c(compile_paramestimates_monsonly_info[[i]][[j]],
                                                            one_sim_informative$compile_paramestimates_monsonly[[i]][[j]])
        compile_paramestimates_monsonly_noninfo[[i]][[j]] <- c(compile_paramestimates_monsonly_noninfo[[i]][[j]],
                                                               one_sim_noninformative$compile_paramestimates_monsonly[[i]][[j]])
      }
    for(j in 1:6){
      compile_paramestimates_regcalib_info[[i]][[j]] <- c(compile_paramestimates_regcalib_info[[i]][[j]],
                                                          one_sim_informative$compile_paramestimates_regcalib[[i]][[j]])
      compile_paramestimates_regcalib_noninfo[[i]][[j]] <- c(compile_paramestimates_regcalib_noninfo[[i]][[j]],
                                                             one_sim_noninformative$compile_paramestimates_regcalib[[i]][[j]])
    }
  }
  
  }
  
  return(out = list(compile_I_x_monsonly_info = compile_I_x_monsonly_info,
                    compile_I_x_regcalib_info = compile_I_x_regcalib_info,
                    compile_I_x_datafusion_info = compile_I_x_datafusion_info,
                    
                    compile_I_x_v2_field_monsonly_info = compile_I_x_v2_field_monsonly_info,
                    compile_I_x_v2_field_regcalib_info = compile_I_x_v2_field_regcalib_info,
                    compile_I_x_v2_field_datafusion_info = compile_I_x_v2_field_datafusion_info,

                    compile_I_x_v2_monsonly_info = compile_I_x_v2_monsonly_info,
                    compile_I_x_v2_regcalib_info = compile_I_x_v2_regcalib_info,
                    compile_I_x_v2_datafusion_info = compile_I_x_v2_datafusion_info,
                    
                    compile_Ave_SD_monsonly_info = compile_Ave_SD_monsonly_info,
                    compile_Ave_SD_regcalib_info = compile_Ave_SD_regcalib_info,
                    compile_Ave_SD_datafus_info = compile_Ave_SD_datafus_info,
                    
                    compile_P_x_monsonly_info = compile_P_x_monsonly_info,
                    compile_P_x_regcalib_info = compile_P_x_regcalib_info,
                    compile_P_x_datafusion_info = compile_P_x_datafusion_info,
                    
                    compile_Corr_x_monsonly_info = compile_Corr_x_monsonly_info,
                    compile_Corr_x_regcalib_info = compile_Corr_x_regcalib_info,
                    compile_Corr_x_datafusion_info = compile_Corr_x_datafusion_info,
                    
                    compile_Time_monsonly_info = compile_Time_monsonly_info,
                    compile_Time_regcalib_info = compile_Time_regcalib_info,
                    compile_Time_datafusion_info = compile_Time_datafusion_info,
                    
                    compile_I_x_monsonly_noninfo = compile_I_x_monsonly_noninfo,
                    compile_I_x_regcalib_noninfo = compile_I_x_regcalib_noninfo,
                    compile_I_x_datafusion_noninfo = compile_I_x_datafusion_noninfo,
                    
                    compile_I_x_v2_field_monsonly_noninfo = compile_I_x_v2_field_monsonly_noninfo,
                    compile_I_x_v2_field_regcalib_noninfo = compile_I_x_v2_field_regcalib_noninfo,
                    compile_I_x_v2_field_datafusion_noninfo = compile_I_x_v2_field_datafusion_noninfo,
                    
                    compile_I_x_v2_monsonly_noninfo = compile_I_x_v2_monsonly_noninfo,
                    compile_I_x_v2_regcalib_noninfo = compile_I_x_v2_regcalib_noninfo,
                    compile_I_x_v2_datafusion_noninfo = compile_I_x_v2_datafusion_noninfo,
                    
                    compile_Ave_SD_monsonly_noninfo = compile_Ave_SD_monsonly_noninfo,
                    compile_Ave_SD_regcalib_noninfo = compile_Ave_SD_regcalib_noninfo,
                    compile_Ave_SD_datafus_noninfo = compile_Ave_SD_datafus_noninfo,
                    
                    compile_P_x_monsonly_noninfo = compile_P_x_monsonly_noninfo,
                    compile_P_x_regcalib_noninfo = compile_P_x_regcalib_noninfo,
                    compile_P_x_datafusion_noninfo = compile_P_x_datafusion_noninfo,
                    
                    compile_Corr_x_monsonly_noninfo = compile_Corr_x_monsonly_noninfo,
                    compile_Corr_x_regcalib_noninfo = compile_Corr_x_regcalib_noninfo,
                    compile_Corr_x_datafusion_noninfo = compile_Corr_x_datafusion_noninfo,
                    
                    compile_Time_monsonly_noninfo = compile_Time_monsonly_noninfo,
                    compile_Time_regcalib_noninfo = compile_Time_regcalib_noninfo,
                    compile_Time_datafusion_noninfo = compile_Time_datafusion_noninfo,
                    
                    compile_paramestimates_datafusion_info = compile_paramestimates_datafusion_info,
                    compile_paramestimates_datafusion_noninfo = compile_paramestimates_datafusion_noninfo,
                    compile_paramestimates_regcalib_info = compile_paramestimates_regcalib_info,
                    compile_paramestimates_regcalib_noninfo = compile_paramestimates_regcalib_noninfo,
                    compile_paramestimates_monsonly_info = compile_paramestimates_monsonly_info,
                    compile_paramestimates_monsonly_noninfo = compile_paramestimates_monsonly_noninfo,
                    
                    compile_mlik_data1_info = compile_mlik_data1_info,
                    compile_mlik_data2_info = compile_mlik_data2_info,
                    compile_mlik_data3_info = compile_mlik_data3_info,
                    compile_mlik_data1_noninfo = compile_mlik_data1_noninfo,
                    compile_mlik_data2_noninfo = compile_mlik_data2_noninfo,
                    compile_mlik_data3_noninfo = compile_mlik_data3_noninfo,
                    compile_weights_data1_info = compile_weights_data1_info,
                    compile_weights_data2_info = compile_weights_data2_info,
                    compile_weights_data3_info = compile_weights_data3_info,
                    compile_weights_data1_noninfo = compile_weights_data1_noninfo,
                    compile_weights_data2_noninfo = compile_weights_data2_noninfo,
                    compile_weights_data3_noninfo = compile_weights_data3_noninfo,
                    compile_index_model_info = compile_index_model_info,
                    compile_index_model_noninfo = compile_index_model_noninfo))
  
}




Sim_result <- Full_sim_ortho_error(n_sim = 20,
                                   max_iter = 10,
                                   tolerance = 0.1)

group = "Z"

save(Sim_result, file = paste0(save.path,"New_Group_",group,".RData"))



